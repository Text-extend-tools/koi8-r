#include "koi8r.h"


// utf-8 encoding for koi8-r characters
static unsigned char utf8[128][3] = {
    {226, 148, 128},
    {226, 148, 130},
    {226, 148, 140},
    {226, 148, 144},
    {226, 148, 148},
    {226, 148, 152},
    {226, 148, 156},
    {226, 148, 164},

    {226, 148, 172},
    {226, 148, 180},
    {226, 148, 188},
    {226, 150, 128},
    {226, 150, 132},
    {226, 150, 136},
    {226, 150, 140},
    {226, 150, 144},

    {226, 150, 145},
    {226, 150, 146},
    {226, 150, 147},
    {226, 140, 160},
    {226, 150, 160},
    {226, 136, 153},
    {226, 136, 154},
    {226, 137, 136},

    {226, 137, 164},
    {226, 137, 165},
    {194, 160, 0},
    {226, 140, 161},
    {194, 176, 0},
    {194, 178, 0},
    {194, 183, 0},
    {195, 183, 0},

    {226, 149, 144},
    {226, 149, 145},
    {226, 149, 146},
    {209, 145, 0},
    {226, 149, 147},
    {226, 149, 148},
    {226, 149, 149},
    {226, 149, 150},

    {226, 149, 151},
    {226, 149, 152},
    {226, 149, 153},
    {226, 149, 154},
    {226, 149, 155},
    {226, 149, 156},
    {226, 149, 157},
    {226, 149, 158},

    {226, 149, 159},
    {226, 149, 160},
    {226, 149, 161},
    {208, 129, 0},
    {226, 149, 162},
    {226, 149, 163},
    {226, 149, 164},
    {226, 149, 165},

    {226, 149, 166},
    {226, 149, 167},
    {226, 149, 168},
    {226, 149, 169},
    {226, 149, 170},
    {226, 149, 171},
    {226, 149, 172},
    {194, 169, 0},

    {209, 142, 0},
    {208, 176, 0},
    {208, 177, 0},
    {209, 134, 0},
    {208, 180, 0},
    {208, 181, 0},
    {209, 132, 0},
    {208, 179, 0},

    {209, 133, 0},
    {208, 184, 0},
    {208, 185, 0},
    {208, 186, 0},
    {208, 187, 0},
    {208, 188, 0},
    {208, 189, 0},
    {208, 190, 0},

    {208, 191, 0},
    {209, 143, 0},
    {209, 128, 0},
    {209, 129, 0},
    {209, 130, 0},
    {209, 131, 0},
    {208, 182, 0},
    {208, 178, 0},

    {209, 140, 0},
    {209, 139, 0},
    {208, 183, 0},
    {209, 136, 0},
    {209, 141, 0},
    {209, 137, 0},
    {209, 135, 0},
    {209, 138, 0},

    {208, 174, 0},
    {208, 144, 0},
    {208, 145, 0},
    {208, 166, 0},
    {208, 148, 0},
    {208, 149, 0},
    {208, 164, 0},
    {208, 147, 0},

    {208, 165, 0},
    {208, 152, 0},
    {208, 153, 0},
    {208, 154, 0},
    {208, 155, 0},
    {208, 156, 0},
    {208, 157, 0},
    {208, 158, 0},

    {208, 159, 0},
    {208, 175, 0},
    {208, 160, 0},
    {208, 161, 0},
    {208, 162, 0},
    {208, 163, 0},
    {208, 150, 0},
    {208, 146, 0},

    {208, 172, 0},
    {208, 171, 0},
    {208, 151, 0},
    {208, 168, 0},
    {208, 173, 0},
    {208, 169, 0},
    {208, 167, 0},
    {208, 170, 0}
};


/* Translate koi8-r string to utf-8 string.
 * String can be truncated if there is not enough buffer size.
 *
 * In:
 *      str - source string in koi8-r encoding
 *      buf - ptr to receiving buffer
 *      size - buffer size
 * Return:
 *      number of bytes written to buffer
 */
size_t koi8r_to_utf8(const char *str, char *buf, size_t size) {
    const unsigned char *s = (const unsigned char*)str;
    unsigned char *d = (unsigned char*)buf;
    size_t dlen = 0;
    size--;

    for (; *s; s++) {
        unsigned char c = *s;
        if (c < 0x80) {
            if (dlen >= size) break;
            d[dlen++] = c;
        } else {
            unsigned char *u = utf8[c-0x80];
            if (u[0] < 0xE0) {
                if (dlen + 2 >= size) break;
                d[dlen++] = u[0];
                d[dlen++] = u[1];
            } else {
                if (dlen + 3 >= size) break;
                d[dlen++] = u[0];
                d[dlen++] = u[1];
                d[dlen++] = u[2];
            }
        }
    }

    d[dlen] = 0;
    return dlen;
}
